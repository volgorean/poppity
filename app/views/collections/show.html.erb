<div id="app" class="flexi-c r">
  <div class="flexi-i side-bar">
    <div class="card">
      <%= card_image(collection_path(@collection), @collection.image.url) %>
      <%= link_to @collection.name, collection_path(@collection), class: "card-title" %>
    </div>
  </div>

  <div class="flexi-i listing">
    <template v-for="group in result">
      <h3 class="year-title">{{ group.year }}</h3>

      <div class="cards">
        <div
          v-for="badge in group.badges"
          class="card"
          :class="{'card-gold': badge.wish}">

          <% if current_user %>
            <div class="card-star" :class="{'active': badge.wish}" @click.prevent="wish(badge)"></div>
          <% end %>

          <a
            :href="badge.link"
            class="card-image"
            :style="{
              background: 'url('+badge.image+') no-repeat center',
              backgroundSize: 'contain'
            }"></a>
          
          <a :href="badge.link" class="card-title">{{ badge.name }}</a>
        </div>
      </div>
    </template>
  </div>
</div>

<script>
  var vivi = new Vue({
    el: "#app",
    data: {
      page: 1,
      fetching: false,
      result: <%= raw @badges.to_json %>
    },
    methods: {
      wish: function(badge) {
        var toggle = (badge.wish ? "/unwish" : "/wish")

        fetch("/badges/"+badge.id+toggle,{
          method: "POST",
          headers: {
            "X-CSRF-Token": "<%= form_authenticity_token.to_s %>"
          },
          credentials: "same-origin"
        })
        .then(function(res){  
          badge.wish = !badge.wish
        })
        .catch(function(res){ console.log(res) })
      },
      nextPage: function(){
        var data = this.$data
        this.fetching = true
        data.page ++

        fetch("/collections/<%= @collection.id %>.json?page="+data.page, {
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": "<%= form_authenticity_token.to_s %>"
          },
          credentials: "same-origin"
        })
        .then(res=>res.json())
        .then(function(res){  
          res.forEach( e => {
            var last = data.result[data.result.length-1]

            // console.log()

            if (e.year == last.year) {
              last.badges = last.badges.concat(e.badges)
            } else {
              data.result = data.result.concat(e)
            }
          })

          data.fetching = false
        })
        .catch(function(res){ console.log(res) })
      }
    },
    mounted() {
      window.addEventListener('scroll', () => {
        if(window.pageYOffset + window.innerHeight >= document.documentElement.scrollHeight - 80) {
          if (!this.$data.fetching) {
            this.nextPage()
          }
        }
      })
    }
  });
</script>